{
	"name": "Hack_loading",
	"properties": {
		"content": {
			"query": "CREATE DATABASE SCOPED CREDENTIAL ADLS_Hack2\nWITH \n\tIDENTITY = 'kalstor',\n\tSECRET = 'qX4XhafEj4Ii64iAyJLEf/+YH6seDT2o2uSINZcGpreDKpJAKEWC8l9Ump5UQc2iCLKBKtrqxttG/r+XNaUe5g=='\n\nCreate external data source ADLSHack2\nWITH \n( LOCATION = 'abfss://staging@kalstor.dfs.core.windows.net',\n\tCREDENTIAL = ADLS_Hack2,\n\tTYPE = HADOOP\n)\n\n\n\nCREATE EXTERNAL FILE FORMAT csv\nWith\n( FORMAT_TYPE = DELIMITEDTEXT,\n  FORMAT_OPTIONS (\n\tFIELD_TERMINATOR = '|'\n    )\n)\n\n-- DIM PRODUCT --\n----------------- \n\nDROP external table ext_dimproduct\nCREATE EXTERNAL TABLE ext_dimproduct\n(\n\t[ProductKey] [int] NOT NULL,\n\t[ProductAlternateKey] [nvarchar](25) NULL,\n\t[ProductSubcategoryKey] [int] NULL,\n\t[WeightUnitMeasureCode] [nchar](3) NULL,\n\t[SizeUnitMeasureCode] [nchar](3) NULL,\n\t[EnglishProductName] [nvarchar](50) NOT NULL,\n\t[SpanishProductName] [nvarchar](50) NULL,\n\t[FrenchProductName] [nvarchar](50) NULL,\n\t[StandardCost] [money] NULL,\n\t[FinishedGoodsFlag] [bit] NOT NULL,\n\t[Color] [nvarchar](15) NOT NULL,\n\t[SafetyStockLevel] [smallint] NULL,\n\t[ReorderPoint] [smallint] NULL,\n\t[ListPrice] [money] NULL,\n\t[Size] [nvarchar](50) NULL,\n\t[SizeRange] [nvarchar](50) NULL,\n\t[Weight] [float] NULL,\n\t[DaysToManufacture] [int] NULL,\n\t[ProductLine] [nchar](2) NULL,\n\t[DealerPrice] [money] NULL,\n\t[Class] [nchar](2) NULL,\n\t[Style] [nchar](2) NULL,\n\t[ModelName] [nvarchar](50) NULL,\n\t[EnglishDescription] [nvarchar](400) NULL,\n\t[FrenchDescription] [nvarchar](400) NULL,\n\t[ChineseDescription] [nvarchar](400) NULL,\n\t[ArabicDescription] [nvarchar](400) NULL,\n\t[HebrewDescription] [nvarchar](400) NULL,\n\t[ThaiDescription] [nvarchar](400) NULL,\n\t[GermanDescription] [nvarchar](400) NULL,\n\t[JapaneseDescription] [nvarchar](400) NULL,\n\t[TurkishDescription] [nvarchar](400) NULL,\n\t[StartDate] [datetime] NULL,\n\t[EndDate] [datetime] NULL,\n\t[Status] [nvarchar](7) NULL\n)\nWITH\n(\n    LOCATION = 'dimproduct',\n    DATA_SOURCE = ADLSHack2,\n    FILE_FORMAT = csv,\n    REJECT_TYPE = VALUE,\n    REJECT_VALUE = 0    \n)\nGO\n\nselect top 5 * from ext_dimproduct\nselect count(*) from ext_dimproduct\nSELECT COUNT ( DISTINCT [ProductKey] ) FROM ext_dimproduct;\n\nDrop TABLE dimproduct\nCREATE TABLE dimproduct\n(\n\t[ProductKey] [int] NOT NULL,\n\t[ProductAlternateKey] [nvarchar](25) NULL,\n\t[ProductSubcategoryKey] [int] NULL,\n\t[WeightUnitMeasureCode] [nchar](3) NULL,\n\t[SizeUnitMeasureCode] [nchar](3) NULL,\n\t[EnglishProductName] [nvarchar](50) NOT NULL,\n\t[SpanishProductName] [nvarchar](50) NULL,\n\t[FrenchProductName] [nvarchar](50) NULL,\n\t[StandardCost] [money] NULL,\n\t[FinishedGoodsFlag] [bit] NOT NULL,\n\t[Color] [nvarchar](15) NOT NULL,\n\t[SafetyStockLevel] [smallint] NULL,\n\t[ReorderPoint] [smallint] NULL,\n\t[ListPrice] [money] NULL,\n\t[Size] [nvarchar](50) NULL,\n\t[SizeRange] [nvarchar](50) NULL,\n\t[Weight] [float] NULL,\n\t[DaysToManufacture] [int] NULL,\n\t[ProductLine] [nchar](2) NULL,\n\t[DealerPrice] [money] NULL,\n\t[Class] [nchar](2) NULL,\n\t[Style] [nchar](2) NULL,\n\t[ModelName] [nvarchar](50) NULL,\n\t[EnglishDescription] [nvarchar](400) NULL,\n\t[FrenchDescription] [nvarchar](400) NULL,\n\t[ChineseDescription] [nvarchar](400) NULL,\n\t[ArabicDescription] [nvarchar](400) NULL,\n\t[HebrewDescription] [nvarchar](400) NULL,\n\t[ThaiDescription] [nvarchar](400) NULL,\n\t[GermanDescription] [nvarchar](400) NULL,\n\t[JapaneseDescription] [nvarchar](400) NULL,\n\t[TurkishDescription] [nvarchar](400) NULL,\n\t[StartDate] [datetime] NULL,\n\t[EndDate] [datetime] NULL,\n\t[Status] [nvarchar](7) NULL\n)\nWITH\n(\n   DISTRIBUTION = HASH(ProductKey),\n   CLUSTERED COLUMNSTORE INDEX\n)\nGO\n\nINSERT INTO dimproduct \n\tSELECT * from ext_dimproduct\n\nSELECT count(*) from dimproduct\n\n-- FactInternetSales --\n-----------------------\n\nCREATE EXTERNAL TABLE ext_FactInternetSales\n(\n\t[ProductKey] [int] NOT NULL,\n\t[OrderDateKey] [int] NOT NULL,\n\t[DueDateKey] [int] NOT NULL,\n\t[ShipDateKey] [int] NOT NULL,\n\t[CustomerKey] [int] NOT NULL,\n\t[PromotionKey] [int] NOT NULL,\n\t[CurrencyKey] [int] NOT NULL,\n\t[SalesTerritoryKey] [int] NOT NULL,\n\t[SalesOrderNumber] [nvarchar](20) NOT NULL,\n\t[SalesOrderLineNumber] [tinyint] NOT NULL,\n\t[RevisionNumber] [tinyint] NOT NULL,\n\t[OrderQuantity] [smallint] NOT NULL,\n\t[UnitPrice] [money] NOT NULL,\n\t[ExtendedAmount] [money] NOT NULL,\n\t[UnitPriceDiscountPct] [float] NOT NULL,\n\t[DiscountAmount] [float] NOT NULL,\n\t[ProductStandardCost] [money] NOT NULL,\n\t[TotalProductCost] [money] NOT NULL,\n\t[SalesAmount] [money] NOT NULL,\n\t[TaxAmt] [money] NOT NULL,\n\t[Freight] [money] NOT NULL,\n\t[CarrierTrackingNumber] [nvarchar](25) NULL,\n\t[CustomerPONumber] [nvarchar](25) NULL\n)\nWITH\n(\n    LOCATION = 'factinternetsales',\n    DATA_SOURCE = ADLSHack2,\n    FILE_FORMAT = csv,\n    REJECT_TYPE = VALUE,\n    REJECT_VALUE = 0    \n)\nGO\n\nSelect top 10 * from ext_FactInternetSales\nSelect count(*) from ext_FactInternetSales\nSELECT COUNT ( DISTINCT [ProductKey] ) FROM ext_FactInternetSales; --!! 158\n\nCREATE TABLE FactInternetSales\n(\n\t[ProductKey] [int] NOT NULL,\n\t[OrderDateKey] [int] NOT NULL,\n\t[DueDateKey] [int] NOT NULL,\n\t[ShipDateKey] [int] NOT NULL,\n\t[CustomerKey] [int] NOT NULL,\n\t[PromotionKey] [int] NOT NULL,\n\t[CurrencyKey] [int] NOT NULL,\n\t[SalesTerritoryKey] [int] NOT NULL,\n\t[SalesOrderNumber] [nvarchar](20) NOT NULL,\n\t[SalesOrderLineNumber] [tinyint] NOT NULL,\n\t[RevisionNumber] [tinyint] NOT NULL,\n\t[OrderQuantity] [smallint] NOT NULL,\n\t[UnitPrice] [money] NOT NULL,\n\t[ExtendedAmount] [money] NOT NULL,\n\t[UnitPriceDiscountPct] [float] NOT NULL,\n\t[DiscountAmount] [float] NOT NULL,\n\t[ProductStandardCost] [money] NOT NULL,\n\t[TotalProductCost] [money] NOT NULL,\n\t[SalesAmount] [money] NOT NULL,\n\t[TaxAmt] [money] NOT NULL,\n\t[Freight] [money] NOT NULL,\n\t[CarrierTrackingNumber] [nvarchar](25) NULL,\n\t[CustomerPONumber] [nvarchar](25) NULL\n)\nWITH\n(\n\tDISTRIBUTION = ROUND_ROBIN,\n\tCLUSTERED COLUMNSTORE INDEX\n)\nGO\nINSERT INTO FactInternetSales \n\tSELECT * from ext_FactInternetSales\n\nSELECT Count(*) from FactInternetSales\n\n--------------------------------------------------------------------------------Jointure--------------------------------------\n\nSELECT f.[ProductKey], d.[EnglishProductName], f.[OrderDateKey], sum(f.[SalesAmount])\n\tFROM FactInternetSales f, dimproduct d\n\tWHERE f.[ProductKey] = d.[ProductKey]\n\tGroup by f.[ProductKey], d.[EnglishProductName],f.[OrderDateKey]\n\n\nSELECT * FROM sys.dm_pdw_request_steps\nWHERE request_id = 'QID116197'\nORDER BY step_index;\n-- Shuffle = 203\n-- PartitionMoveOperation = 2328\n-- ReturnOperation = 2343\n\n-----Security Step 5\n--Master--\nCREATE LOGIN rptUser with password ='grain2caf&';\nCREATE USER rptUser for LOGIN rptUser\n\nGRANT SELECT ON OBJECT dbo.dimproduct.[EnglishDescription] to rptusr;\nGRANT SELECT ON OBJECT dbo.dimproduct.[ProductKey] to rptusr;\nGRANT SELECT ON OBJECT dbo.FactInternetSales.[ProductKey] to rptusr;\nGRANT SELECT ON OBJECT dbo.FactInternetSales.[OrderDateKey] to rptusr; \nGRANT SELECT ON OBJECT dbo.FactInternetSales.[SalesAmount] to rptusr; \n\n---Query not optimized step 6\n\nDBCC PDW_SHOWSPACEUSED('dbo.FactInternetSales');\n\n\n-- Step 7 - subsequent executions of this query faster\nALTER DATABASE SQLDB1\nSET RESULT_SET_CACHING ON\n\n\n\n\n\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"name": "SQLDB1",
				"type": "SqlPool"
			}
		},
		"type": "SqlQuery"
	}
}